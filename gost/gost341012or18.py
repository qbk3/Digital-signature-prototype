from os import urandom

from .utils import bytes2long
from .utils import hexdec
from .utils import long2bytes
from .utils import modinvert


MODE2SIZE = {
    2001: 32,
    2012: 64,
}


DEFAULT_CURVE = "GostR3410_2012_TC26_ParamSetA"
# Curve parameters are the following: p, q, a, b, x, y
CURVE_PARAMS_TEXT = {
    "GostR3410_2012_TC26_ParamSetA": (
        "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDC7",
        "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF27E69532F48D89116FF22B8D4E0560609B4B38ABFAD2B85DCACDB1411F10B275",
        "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDC4",
        "E8C2505DEDFC86DDC1BD0B2B6667F1DA34B82574761CB0E879BD081CFD0B6265EE3CB090F30D27614CB4574010DA90DD862EF9D4EBEE4761503190785A71C760",
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003",
        "7503CFE87A836AE3A61B8816E25450E6CE5E1C93ACF1ABC1778064FDCBEFA921DF1626BE4FD036E93D75E6A50E3A41E98028FE5FC235F5B889A589CB5215F2A4",
    ),
    "GostR3410_2012_TC26_ParamSetB": (
        "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006F",
        "800000000000000000000000000000000000000000000000000000000000000149A1EC142565A545ACFDB77BD9D40CFA8B996712101BEA0EC6346C54374F25BD",
        "8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006C",
        "687D1B459DC841457E3E06CF6F5E2517B97C7D614AF138BCBF85DC806C4B289F3E965D2DB1416D217F8B276FAD1AB69C50F78BEE1FA3106EFB8CCBC7C5140116",
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002",
        "1A8F7EDA389B094C2C071E3647A8940F3C123B697578C213BE6DD9E6C8EC7335DCB228FD1EDF4A39152CBCAAF8C0398828041055F94CEEEC7E21340780FE41BD"
    ),
    "MyGostParamSet1":(
        "0000000000000000000000000000000000000000000000000000000000000001670d2d55c14b26218dbd729746e9295018bde40c44844df2d16f75c16ec394cb",
        "0000000000000000000000000000000000000000000000000000000000000001670d2d55c14b26218dbd729746e9294fcc3c58a3932ea6777cc0b0f67aa789f5",
        "0000000000000000000000000000000000000000000000000000000000000000dbceb2139469659d385747fbaf37754581e4abed51e883e1da6d054d6b8c9637",
        "0000000000000000000000000000000000000000000000000000000000000000b6afe4b3fde502d2d96d95e357b4f3e44dac7c367910e33fd96832512d7b75f0",
        "000000000000000000000000000000000000000000000000000000000000000127f01adc8431d40bcc091f3595300416850c1457a45028b80fbfde0996e53f13",
        "00000000000000000000000000000000000000000000000000000000000000005ae8f9d27135fd42c641ff315880dcf71022c655b5af362314be16533b4b2b91"
    ),
    "MyGostParamSet2":(
        "00000000000000000000000000000000000000000000000000000000000000012513a22001e63ff8a0662d9755ae7b9b2059bedab261b2d2c60cfb15d015008d",
        "00000000000000000000000000000000000000000000000000000000000000012513a22001e63ff8a0662d9755ae7b9a8d1b857db3088b1bce94781375c59c2d",
        "00000000000000000000000000000000000000000000000000000000000000005d7ecf3e7f0a8b54f3ee874d0a8fa525941fd657191db10596ae9602d692357c",
        "000000000000000000000000000000000000000000000000000000000000000020bc6510c087cbd8027e5739d9a05449e94346db47b8dd3ad726e2f987ac6a16",
        "0000000000000000000000000000000000000000000000000000000000000000fe7e09dd8c1df5d9fc10e269214f30b99f02dcd1bb74f83be7ccb1422bc1e0b0",
        "000000000000000000000000000000000000000000000000000000000000000118eba20d01bf8d6049e27bd1de4dbf962c8f1d0ff01f28c2fae1295b77cdb656"
    ),
    "MyGostParamSet3":(
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c150140e1d60e092cb2863981d008abd5a67",
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c14e847ffaaa4532d04e62dc42fa1d847e91",
        "000000000000000000000000000000000000000000000000000000000000000066c4d4ed93d7b7b749125101a5dfddd87b1bba70d2cb86c54eb99498c05114d1",
        "00000000000000000000000000000000000000000000000000000000000000017edc81e17e59af40723a3471b5e0e450157f6652faaba2455f719580766200ad",
        "0000000000000000000000000000000000000000000000000000000000000001c1db8e5dace9e61ffd65f964db5ca30b0f0cc10a2a297c2ed93a2f77b518fe5e",
        "0000000000000000000000000000000000000000000000000000000000000001999d6324a7d8356320ac62e4fc64d1215c143fb394f906946f95630e3598efd8"
    ),
    "MyGostParamSet4":(
        "0000000000000000000000000000000000000000000000000000000000000001c55bb763a6dfdfae03b5a50d2ffe46cc0ff2f0a025e1461df3da8744397f57c3",
        "0000000000000000000000000000000000000000000000000000000000000001c55bb763a6dfdfae03b5a50d2ffe46cc169f71fba55b0a39ec4c69f520657b8f",
        "00000000000000000000000000000000000000000000000000000000000000006b06d852310d38cee815974d258652240ce6a6ac5b13c88be1d5df4d8762ed08",
        "0000000000000000000000000000000000000000000000000000000000000000e1709ddfbc99324d840514e415fc952e7d397410dc6e76b46949aa19a63ee82a",
        "00000000000000000000000000000000000000000000000000000000000000014435b77a2167149bb662b3b093d39d9ceeb77748e950cc195ba5af8c0ab83f9a",
        "0000000000000000000000000000000000000000000000000000000000000001b1dc74a1004bf1a852ff5d207739e5d45b2bdb21a44d90746a502dd2b79a79b0"
    ),
    "MyGostParamSet5":(
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b4c7cddbbc67b8338f51c580cd26a764cf",
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b5eec595d554e04c12fdc0b189209505a5",
        "0000000000000000000000000000000000000000000000000000000000000000a57a05e878f8f0ccabaf58ac2ba3ce3ed08ed9d091bc126fd4db8552abd8173e",
        "00000000000000000000000000000000000000000000000000000000000000004f899a2398a60df24d7ab15555c1c78a2b64ea6deddcb9c93397edb4c3de8731",
        "0000000000000000000000000000000000000000000000000000000000000000ed28e859e94587f6eca6b16375d77f53ac706f6fa45438f828e6ff24460cd607",
        "000000000000000000000000000000000000000000000000000000000000000039f07d9dde1fdc58b2afd7a3cab3a7dcbb595b7efa20182ea4f630d2801f7f9b"
    ),
    "MyGostParamSet6":(
        "000000000000000000000000000000000000000000000000000000000000000131801ff70ba0f7e8d32cad304bd6d740b7c40548d6507614b18c72398740a593",
        "000000000000000000000000000000000000000000000000000000000000000131801ff70ba0f7e8d32cad304bd6d741904ba94d834b63530e6940534054121b",
        "0000000000000000000000000000000000000000000000000000000000000000752e5adcb74b81ca03ada6603be547e221fbc7e491485d13c0e6f76b3aad1d69",
        "00000000000000000000000000000000000000000000000000000000000000008bf8b450ce431785f2a67d1cfd9e1d1d85a005ec60252d633d8882a41502f92a",
        "000000000000000000000000000000000000000000000000000000000000000063e109612582f68835094e63b0fe1d1d6ce0ba56a821e8e47b2cbf6bb5f178a6",
        "000000000000000000000000000000000000000000000000000000000000000017ee6468c92ff7a09d794fe028e54a02d19fecd511f7ab98b60794df5296d7f2"
    ),
    "MyGostParamSetSanya":(
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c150140e1d60e092cb2863981d008abd5a67",
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c14ff2798f9fa436717d04cbba850d898bfd",
        "0000000000000000000000000000000000000000000000000000000000000000b81b5bdc4063c177baa0e84c45cbb300cad96d6f55e4c308f6037cba6426f5dc",
        "0000000000000000000000000000000000000000000000000000000000000000c3e69877924edf4f996b6f559a587863e39ab754ef7cc10d66bbe85ad7e52044",
        "0000000000000000000000000000000000000000000000000000000000000001f49f08c285fd0bd7564584e06d121d75f9a1befae1f4ddea7e19846a17633f1e",
        "00000000000000000000000000000000000000000000000000000000000000012f9626444ed0ee6f589d4224ca385981334df83f5c79e4572f58ea613ac9fbcc"
    ),
    "MyGostParamSetDisc1":(
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b4c7cddbbc67b8338f51c580cd26a764cf",
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b6b6e8edc90c34a81758e848175f5ab65f",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000186a0",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000188f8",
        "00000000000000000000000000000000000000000000000000000000000000014dfd82c6315a6d1eec4318371fc2fe5736c1111247b2e624fcadc17f22d3e974",
        "000000000000000000000000000000000000000000000000000000000000000004c789b3924b1fc64f828faf30427117443f849b2cefd51cd8df2d431662e0d8"
    ),
    "MyGostParamSetDisc2":(
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b4c7cddbbc67b8338f51c580cd26a764cf",
        "00000000000000000000000000000000000000000000000000000000000000014e09e42e06c0299a52f77c43864613b5f88563c81a1ba5218a9525951562e971",
        "000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000186a0",
        "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018988",
        "0000000000000000000000000000000000000000000000000000000000000000cef175a4bb8e9da05dda8c763cc6a0a726fca1ed801c2ea22bb274da43998c5b",
        "0000000000000000000000000000000000000000000000000000000000000000e92a2599b4ef87aa5569c86c939f4ead57d3ea49eb45bff1320be5b518d45335"
    ),
    "MyGostParamSetDisc3":(
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c150140e1d60e092cb2863981d008abd5a67",
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c1509e50e14512ce34e27ed86f1e5e329e47",
        "0000000000000000000000000000000000000000000000000000000000000000fbeff180a3f5d514ae8e4467a37b60a80a070eb07049659431cc0e80455ead33",
        "0000000000000000000000000000000000000000000000000000000000000000fbeff180a3f5d514ae8e4467a37b60a80a070eb07049659431cc0e80455ead8f",
        "00000000000000000000000000000000000000000000000000000000000000007a8d31dd170b427fa8513405b04fb490c70b4a45739045c2d41521c74467f7b6",
        "00000000000000000000000000000000000000000000000000000000000000004d3f53a4229bafd9f6e2a6c38573cddf94d52e8e95d86e1ccabd2880a9f36c51"
    ),
    "MyGostParamSetDisc4":(
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c150140e1d60e092cb2863981d008abd5a67",
        "0000000000000000000000000000000000000000000000000000000000000001f7dfe30147ebaa295d1c88cf46f6c14e8af2203c0741ddda7c6946c67a2ed2c5",
        "00000000000000000000000000000000000000000000000000000000000000006268325fa3291ae0d7ca80626b6919743d92b4d27508d38ef4445bb2bb41d5c6",
        "0000000000000000000000000000000000000000000000000000000000000000bc03df0ae6559af091f292a8be68ee35ff6175397f0ebde80fa7300245186761",
        "0000000000000000000000000000000000000000000000000000000000000001f110d1ecccf17ef94813c8c30ff33ca10b7db343f4f758dee6f4854d58f4ac44",
        "0000000000000000000000000000000000000000000000000000000000000001f1f9abc48d4b7510209f8cbbebdc32c728ed95a3bffe83bd336b39d4d2522fcc"
    )
}

CURVE_PARAMS = {}
for c, params in CURVE_PARAMS_TEXT.items():
    CURVE_PARAMS[c] = [hexdec(param) for param in params]


class GOST3410Curve(object):
    def __iter__(self):
        for i in [self.p, self.q, self.a, self.b, self.x, self.y]:
            yield i

    def __init__(self, p, q, a, b, x, y):
        self.p = bytes2long(p)
        self.q = bytes2long(q)
        self.a = bytes2long(a)
        self.b = bytes2long(b)
        self.x = bytes2long(x)
        self.y = bytes2long(y)
        r1 = self.y * self.y % self.p
        r2 = ((self.x * self.x + self.a) * self.x + self.b) % self.p
        if r2 < 0:
            r2 += self.p
        if r1 != r2:
            raise ValueError("Invalid parameters")

    def _pos(self, v):
        if v < 0:
            return v + self.p
        return v

    def _add(self, p1x, p1y, p2x, p2y):
        if p1x == p2x and p1y == p2y:
            t = ((3 * p1x * p1x + self.a) * modinvert(2 * p1y, self.p)) % self.p
        else:
            tx = self._pos(p2x - p1x) % self.p
            ty = self._pos(p2y - p1y) % self.p
            t = (ty * modinvert(tx, self.p)) % self.p
        tx = self._pos(t * t - p1x - p2x) % self.p
        ty = self._pos(t * (p1x - tx) - p1y) % self.p
        return tx, ty

    def exp(self, degree, x=None, y=None):
        x = x or self.x
        y = y or self.y
        tx = x
        ty = y
        degree -= 1
        if degree == 0:
            raise ValueError("Bad degree value")
        while degree != 0:
            if degree & 1 == 1:
                tx, ty = self._add(tx, ty, x, y)
            degree = degree >> 1
            x, y = self._add(x, y, x, y)
        return tx, ty


def public_key(curve, prv):
    return curve.exp(prv)


def sign(curve, prv, digest, mode=2012):
    """
    :param GOST3410Curve curve: curve
    :param long prv: private key
    :param digest: digest for signing
    :type digest: bytes, 32 or 64 bytes
    :returns: signature
    :rtype: int tuple
    """
    # size = MODE2SIZE[mode]
    size = 64
    q = curve.q
    e = bytes2long(digest) % q
    if e == 0:
        e = 1
    while True:
        k = bytes2long(urandom(size)) % q
        if k == 0:
            continue
        r, _ = curve.exp(k)
        r %= q
        if r == 0:
            continue
        d = prv * r
        k *= e
        s = (d + k) % q
        if s == 0:
            continue
        break
    # return long2bytes(s, size) + long2bytes(r, size)
    return r, s


def verify(curve, pub, digest, signature, mode=2012):
    """
    :param GOST3410Curve curve: curve
    :type pub: (long, long)
    :param digest: digest needed to check
    :type digest: bytes, 32 or 64 bytes
    :param signature: r, s from signature
    :type signature: bytes, 64 or 128 bytes
    :rtype: bool
    """
    r, s = signature
    # size = MODE2SIZE[mode]
    size = 64
    if len(long2bytes(s, size) + long2bytes(r, size)) != size * 2:
        raise ValueError("Invalid signature length")
    q = curve.q
    p = curve.p
    # s = bytes2long(signature[:size])
    # r = bytes2long(signature[size:])
    if r <= 0 or r >= q or s <= 0 or s >= q:
        return False
    e = bytes2long(digest) % curve.q
    if e == 0:
        e = 1
    v = modinvert(e, q)
    z1 = s * v % q
    z2 = q - r * v % q
    p1x, p1y = curve.exp(z1)
    q1x, q1y = curve.exp(z2, pub[0], pub[1])
    lm = q1x - p1x
    if lm < 0:
        lm += p
    lm = modinvert(lm, p)
    z1 = q1y - p1y
    lm = lm * z1 % p
    lm = lm * lm % p
    lm = lm - p1x - q1x
    lm = lm % p
    if lm < 0:
        lm += p
    lm %= q
    # This is not constant time comparison!
    return lm == r


def prv_unmarshal(prv):
    return bytes2long(prv[::-1])


def pub_marshal(pub, mode=2012):
    size = MODE2SIZE[mode]
    return (long2bytes(pub[1], size) + long2bytes(pub[0], size))[::-1]


def pub_unmarshal(pub, mode=2012):
    size = MODE2SIZE[mode]
    pub = pub[::-1]
    return bytes2long(pub[size:]), bytes2long(pub[:size])
